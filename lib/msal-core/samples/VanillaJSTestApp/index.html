<!DOCTYPE html>
<html>

<head>
    <title>Quickstart for MSAL JS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js"></script>
    <script src="dist/msal.js" class="pre"></script>
</head>

<body>
    <h4 id="WelcomeMessage"></h4>
    <button id="SignIn" onclick="signIn()">Sign In</button>
    <br /><br />
    <pre id="json"></pre>

    <script>
        var applicationConfig = {
            clientID: "245e9392-c666-4d51-8f8a-bfd9e55b2456",
            authority: "https://login.microsoftonline.com/common",
            graphScopes: ["user.read"],
            graphEndpoint: "https://graph.microsoft.com/v1.0/me"
        };

        // Setting a default value in JSON format
        var config = Msal.buildConfiguration(
            { clientId: applicationConfig.clientID, authority: applicationConfig.authority, validateAuthority: true, },
            { cacheLocation: "localStorage", storeAuthStateInCookie: true },
            { },
            { }
        );

        var myMSALObj = new Msal.UserAgentApplication(config);
        myMSALObj.handleRedirectCallbacks(acquireTokenRedirectCallBack, acquireTokenErrorRedirectCallBack);

        function signIn() {
            let loginRequest = {
                scopes: applicationConfig.graphScopes
            };
            myMSALObj.loginPopup(loginRequest).then(function (loginResponse) {
                //Login Success
                showWelcomeMessage();
                acquireTokenPopupAndCallMSGraph();
            }, function (error) {
                console.log(error);
            });
        }

        function signOut() {
            myMSALObj.logout();
        }

        function acquireTokenPopupAndCallMSGraph() {
            //Call acquireTokenSilent (iframe) to obtain a token for Microsoft Graph
            let tokenRequest = {
                scopes: applicationConfig.graphScopes
            };
            myMSALObj.acquireTokenSilent(tokenRequest).then(function (tokenResponse) {
                callMSGraph(applicationConfig.graphEndpoint, tokenResponse.accessToken, graphAPICallback);
            }).catch(function (error) {
                console.log(error);
                // Call acquireTokenPopup (popup window) in case of acquireTokenSilent failure due to consent or interaction required ONLY
                if (error.indexOf("consent_required") !== -1 || error.indexOf("interaction_required") !== -1 || error.indexOf("login_required") !== -1) {
                    myMSALObj.acquireTokenPopup(tokenRequest).then(function (tokenResponse) {
                        callMSGraph(applicationConfig.graphEndpoint, tokenResponse.accessToken, graphAPICallback);
                    }).catch(function (error) {
                        console.log(error);
                    });
                }
            });
        }

        function callMSGraph(theUrl, accessToken, callback) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200)
                    callback(JSON.parse(this.responseText));
            }
            xmlHttp.open("GET", theUrl, true); // true for asynchronous
            xmlHttp.setRequestHeader('Authorization', 'Bearer ' + accessToken);
            xmlHttp.send();
        }

        function graphAPICallback(data) {
            //Display user data on DOM
            var divWelcome = document.getElementById('WelcomeMessage');
            divWelcome.innerHTML += " to Microsoft Graph API!!";
            document.getElementById("json").innerHTML = JSON.stringify(data, null, 2);
        }

        function showWelcomeMessage() {
            var divWelcome = document.getElementById('WelcomeMessage');
            divWelcome.innerHTML += 'Welcome ' + myMSALObj.getAccount().userName;
            console.log(myMSALObj.getAccount());
            var loginbutton = document.getElementById('SignIn');
            loginbutton.innerHTML = 'Sign Out';
            loginbutton.setAttribute('onclick', 'signOut();');
        }

        // This function can be removed if you do not need to support IE
        function acquireTokenRedirectAndCallMSGraph() {
            //Call acquireTokenSilent (iframe) to obtain a token for Microsoft Graph
            let tokenRequest = {
                scopes: applicationConfig.graphScopes
            };
            myMSALObj.acquireTokenSilent(tokenRequest).then(function (tokenResponse) {
                callMSGraph(applicationConfig.graphEndpoint, tokenResponse.accessToken, graphAPICallback);
            }).catch(function (error) {
                console.log(error);
                //Call acquireTokenRedirect in case of acquireToken Failure
                if (error.errorMessage.indexOf("consent_required") !== -1 || error.errorMessage.indexOf("interaction_required") !== -1 || error.errorMessage.indexOf("login_required") !== -1) {
                    myMSALObj.acquireTokenRedirect(tokenRequest);
                }
            });
        }

        function acquireTokenRedirectCallBack(response) {
            if (response.tokenType === "access_token") {
                callMSGraph(applicationConfig.graphEndpoint, response.accessToken, graphAPICallback);
            } else {
                console.log("token type is:" + response.tokenType);
            }
        }

        function  acquireTokenErrorRedirectCallBack(error) {
            console.log(error);
        }

        // Browser check variables
        var ua = window.navigator.userAgent;
        var msie = ua.indexOf('MSIE ');
        var msie11 = ua.indexOf('Trident/');
        var msedge = ua.indexOf('Edge/');
        var isIE = msie > 0 || msie11 > 0;
        var isEdge = msedge > 0;

        //If you support IE, our recommendation is that you sign-in using Redirect APIs
        //If you as a developer are testing using Edge InPrivate mode, please add "isEdge" to the if check
        if (!isIE) {
            if (myMSALObj.getAccount()) {// avoid duplicate code execution on page load in case of iframe and popup window.
                showWelcomeMessage();
                acquireTokenPopupAndCallMSGraph();
            }
        }
        else {
            document.getElementById("SignIn").onclick = function () {
                let tokenRequest = {
                    scopes: applicationConfig.graphScopes
                };
                myMSALObj.loginRedirect(tokenRequest);
            };

            if (myMSALObj.getAccount() && !myMSALObj.isCallback(window.location.hash)) {// avoid duplicate code execution on page load in case of iframe and popup window.
                showWelcomeMessage();
                acquireTokenRedirectAndCallMSGraph();
            }
        }
    </script>
</body>

</html>
